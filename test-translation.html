<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModelScope翻译功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .input-group { margin: 10px 0; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 50px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .model-tabs { margin-bottom: 20px; }
        .tab-btn { margin-right: 10px; padding: 10px; background: #e9ecef; border: none; cursor: pointer; }
        .tab-btn.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <h1>ModelScope翻译功能测试</h1>
    
    <div class="test-section">
        <h2>API连接测试</h2>
        <button onclick="testAPIConnection()">测试ModelScope翻译API连接</button>
        <div id="connection-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>翻译功能测试</h2>
        <div class="model-tabs">
            <button class="tab-btn active" onclick="switchTab('chatgpt')">ChatGPT-5</button>
            <button class="tab-btn" onclick="switchTab('nanobanana')">Nano Banana</button>
            <button class="tab-btn" onclick="switchTab('modelscope')">ModelScope</button>
        </div>

        <div id="chatgpt" class="tab-content active">
            <h3>ChatGPT-5 提示词翻译</h3>
            <div class="input-group">
                <label for="chatgpt-prompt">提示词:</label>
                <textarea id="chatgpt-prompt" placeholder="输入中文提示词...">生成一个美丽的日落风景画</textarea>
            </div>
            <button onclick="translateText('chatgpt')">翻译</button>
            <div id="chatgpt-result" class="result"></div>
        </div>

        <div id="nanobanana" class="tab-content">
            <h3>Nano Banana 提示词翻译</h3>
            <div class="input-group">
                <label for="nanobanana-prompt">提示词:</label>
                <textarea id="nanobanana-prompt" placeholder="输入中文提示词...">创造一个未来城市的概念艺术图</textarea>
            </div>
            <button onclick="translateText('nanobanana')">翻译</button>
            <div id="nanobanana-result" class="result"></div>
        </div>

        <div id="modelscope" class="tab-content">
            <h3>ModelScope 提示词翻译</h3>
            <div class="input-group">
                <label for="modelscope-prompt">提示词:</label>
                <textarea id="modelscope-prompt" placeholder="输入中文提示词...">设计一只可爱的小动物角色插画</textarea>
            </div>
            <button onclick="translateText('modelscope')">翻译</button>
            <div id="modelscope-result" class="result"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>空格触发测试</h2>
        <p>在下面输入框中输入中文文字，然后输入三个连续空格来测试自动翻译：</p>
        <input type="text" id="auto-translate-input" placeholder="输入中文后按三个空格自动翻译...">
        <div id="auto-translate-result" class="result"></div>
    </div>

    <script>
        // API基础URL
        const API_BASE = 'http://localhost:8080/api';

        // 切换标签页
        function switchTab(model) {
            // 隐藏所有内容
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // 显示选中的内容
            document.getElementById(model).classList.add('active');
            event.target.classList.add('active');
        }

        // 测试API连接
        async function testAPIConnection() {
            const result = document.getElementById('connection-result');
            result.innerHTML = '正在测试连接...';
            result.className = 'result';
            
            try {
                const response = await fetch(`${API_BASE}/modelscope-key-status`);
                const data = await response.json();
                
                if (data.isSet) {
                    result.innerHTML = '✅ ModelScope API密钥已配置，连接正常！';
                    result.className = 'result success';
                } else {
                    result.innerHTML = '❌ ModelScope API密钥未配置，请检查服务器环境变量';
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `❌ 连接失败: ${error.message}。请确保服务器正在运行 (http://localhost:8080)`;
                result.className = 'result error';
            }
        }

        // 翻译文本
        async function translateText(model) {
            const inputId = `${model}-prompt`;
            const resultId = `${model}-result`;
            const input = document.getElementById(inputId).value;
            const result = document.getElementById(resultId);
            
            if (!input.trim()) {
                result.innerHTML = '请输入要翻译的文本';
                result.className = 'result error';
                return;
            }
            
            result.innerHTML = '正在翻译...';
            result.className = 'result';
            
            try {
                const response = await fetch(`${API_BASE}/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: input, from: 'zh', to: 'en' })
                });
                
                const data = await response.json();
                
                if (data.trans_result && data.trans_result[0]) {
                    const translation = data.trans_result[0].dst;
                    document.getElementById(inputId).value = translation; // 直接替换原文本
                    result.innerHTML = `翻译成功！原文本已替换为：<br><strong>${translation}</strong>`;
                    result.className = 'result success';
                } else {
                    result.innerHTML = '翻译失败：' + (data.error || '未知错误');
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = '翻译请求失败: ' + error.message;
                result.className = 'result error';
            }
        }

        // 自动翻译功能（三个空格触发）
        function setupAutoTranslate() {
            const input = document.getElementById('auto-translate-input');
            let spaceCount = 0;
            
            input.addEventListener('keydown', async function(e) {
                if (e.key === ' ') {
                    spaceCount++;
                    if (spaceCount === 3) {
                        e.preventDefault();
                        await translateAutoText(input.value.trim());
                        spaceCount = 0;
                    }
                } else {
                    spaceCount = 0;
                }
            });
            
            input.addEventListener('input', function(e) {
                if (e.target.value.length === 0) spaceCount = 0;
            });
        }

        // 自动翻译
        async function translateAutoText(text) {
            const result = document.getElementById('auto-translate-result');
            result.innerHTML = '检测到三个空格，正在自动翻译...';
            result.className = 'result';
            
            try {
                const response = await fetch(`${API_BASE}/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: text, from: 'zh', to: 'en' })
                });
                
                const data = await response.json();
                
                if (data.trans_result && data.trans_result[0]) {
                    const translation = data.trans_result[0].dst;
                    document.getElementById('auto-translate-input').value = translation;
                    result.innerHTML = `✅ 自动翻译成功！<br>原文: ${text}<br>译文: <strong>${translation}</strong>`;
                    result.className = 'result success';
                } else {
                    result.innerHTML = '❌ 自动翻译失败: ' + (data.error || '未知错误');
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = '❌ 自动翻译请求失败: ' + error.message;
                result.className = 'result error';
            }
        }

        // 页面加载完成后设置自动翻译
        window.addEventListener('load', setupAutoTranslate);
    </script>
</body>
</html>